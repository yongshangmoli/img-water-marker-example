/*!
 * img-water-marker.js v1.0.4
 * (c) 2020-2020 shellchen
 * Released under the MIT License.
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self)["img-water-marker"]=e()}(this,(function(){"use strict";const t={getType:t=>Object.prototype.toString.call(t),isObject:e=>"[object Object]"===t.getType(e),isString:t=>"string"==typeof t};let e={gap:250,rotateAngle:-20,font:"22px Microsoft JhengHei",fillStyle:"rgba(3, 3, 3, 0.15)",textAlign:"left",textBaseline:"Middle"};const a={setCanvasConfig:(a={})=>{if(t.isObject(a))return e=Object.assign(e,a),e},getCanvasImgData:e=>{let a;if(e&&(t.isString(e)?a=e:t.isObject(e)&&e.target&&"CANVAS"===e.target.tagName&&(a=e.target.getAttribute("id")),a)){const t=document.getElementById(a);return t&&t.toDataURL()}},addText:(t,a,r=0,n=0)=>{t.rotate(e.rotateAngle*Math.PI/180),t.font=e.font,t.fillStyle=e.fillStyle,t.textAlign=e.textAlign,t.textBaseline=e.textBaseline,t.fillText(a||"knowbase",r,n),t.rotate(-e.rotateAngle*Math.PI/180)},drawWaterMarker:(t,r,n)=>{const{width:i,height:s}=r;if(t.drawImage(r,0,0,i,s),!n)return;const{gap:o}=e,g=o/2,c=Math.ceil(i/o),f=Math.ceil(s/g)+3;for(let e=-3;e<c;e++)for(let r=0;r<f;r++)a.addText(t,n,e*o,22+r*g)},getImgUrl:t=>t.match(/src=[\'\"]?([^\'\"]*)[\'\"]?/i)[1],getCanvasHtml:(t,e="imgWithWmCanvas")=>{const r=[];return{content:t.replace(/<img.*?(?:>|\/>)/gi,(t=>(r.push(a.getImgUrl(t)),`<canvas\n                id="${e}${r.length}"\n                >你的浏览器不支持水印，请用谷歌浏览器打开</canvas>`))),imgUrls:r}},getWaterMarkedImg:(t,e,r="imgWithWmCanvas")=>{t.forEach(((t,n)=>{const i=new Image;i.src=t,i.crossOrigin="",i.onload=()=>{const t=document.getElementById(`${r}${n+1}`);t.width=i.width,t.height=i.height;const s=t.getContext("2d");a.drawWaterMarker(s,i,e)}}))},getWaterMarkedImgByOffscreenCanvas:({imgUrls:t,canvasWorker:e,waterMarkerText:a="",canvasIdPrefix:r="imgWithWmCanvas",canvasConfig:n})=>{t.forEach(((t,i)=>{const s=document.getElementById(`${r}${i+1}`);if(s){const r=s.transferControlToOffscreen();e.postMessage({name:"drawImg",text:a,url:t,offscreenCanvas:r,canvasConfig:JSON.stringify(n)},[r])}}))},offscreenCanvasDraw:async t=>{try{if(!t.url||!t.offscreenCanvas)return;const e=await fetch(t.url,{mode:"cors"}),r=await e.blob(),n=await createImageBitmap(r),i=t.offscreenCanvas;i.width=n.width,i.height=n.height;const s=i.getContext("2d");a.setCanvasConfig(JSON.parse(t.canvasConfig||{})),a.drawWaterMarker(s,n,t.text)}catch(t){}},draw:({worker:t,canvasConfig:r={},imgUrls:n=[],waterMarkerText:i,htmlStr:s,canvasIdPrefix:o})=>{let g;if(!Array.isArray(n)){if(!s||"string"!=typeof s)return;g=a.getCanvasHtml(s,o)}a.setCanvasConfig(r);const c=g?g.imgUrls:n;return t?a.getWaterMarkedImgByOffscreenCanvas({imgUrls:c,canvasWorker:t,waterMarkerText:i,canvasIdPrefix:o,canvasConfig:e}):a.getWaterMarkedImg(c,i,o),g&&g.content}};return a}));
